# <img height="25" src="./images/AILLogoSmall.png" width="40"/> IAM-service

<a href="https://www.legosoft.com.mx"><img height="150px" src="./images/Icon.png" alt="AI Legorreta" align="left"/></a>
Microservice that acts as the graph repository for a generic IAM (Identity Access Management).

The `iam-ui` is the microservice that utilizes most the `iam-service`. Others microservice utilizes this 
microservice when they need access to the permits or needs more detail information from the IAM Neo4j
graph database.

note: this microservice is one of the oldest one, so little graphql is used, but Spring Data


## Introduction

The `iam-service` repository microservice is in charge to do all operations for the IAM database. Is has
many REST GET, POST and DELETE  REST service that are grouped in three groups:

- Operational: All REST services used by any application that utilized the IAM. In other words it is 
the day to day REST services.

- Administration: All REST services for administration purpose. Master administrator, IAM administrator
and a company Administrator operations. These REST service normally are high priority and change the 
configuration for permits, roles, profiles, users, etc.

- Statistics: These REST services are for UI Dash board statistics. Future version will implement more
analytics functionality for the IAM.

note: `iam-service` microservice is a protected resource so all REST services need a valid JWT produced
token by Oauth2  microservice. For develop purpose the developer can eliminate this restriction 
commenting the  @EnableResourceServer annotation in the main application.

## IAM database

The Neo4j database called iamDB is declared and created (if not exists) by the third party docker-compose.
Also, when the database iamDB is created the micro.services runs a script `start.cypher` to run minimal
data needed. The `dev.cypher` is a more complete example for the database and it

### IAMDB ports

By default `iamDB` is configured to use the 7687 port to be accessed externally.

Other ports are port 7474, 7473 for :bolt driver

## Compilation

When this microservice is compiled it sends the following warning:

```
The entity XXXXXXX is using a Long value for storing internally generated Neo4j ids. The Neo4j internal Long Ids are deprecated, please consider using an external ID generator.
```

As for documentation in SDN Neo4j it still utilizes Long es generated value and in :

```
https://community.neo4j.com/t5/drivers-stacks/list-of-relationshipproperties/m-p/61214
```

Is says Please ignore this warning for now because we are still not sure if we will just stick with the
old `id` format and dismiss this warning in the GA version.

This maybe change for Neo4j 5 and SDN 7

### Design notes

- All repositories extends from Neo4j repository.

- Three controllers are developed: one for Administrators, one for Users and one for Statistics.

- The GET REST services that produce a graph as `json` are created to be used by Alchemys.js type 
data visualization inside the `iam-ui` front end. Other visualization tool will need to change these 
services.

### Events generated

All events generated to `kafka` came with a field "notificaFacultad" where indicates that notification must be sent 
to all user with this permit.

This is the event generated by this micro.servico to the Even-logger

- Event name: ALTA_FACULTAD
  Action: new a permit.
  Data: FacultadDTO
- Event name: ACTUALIZA_FACULTAD
  Action: update a permit.
  Data: FacultadDTO
- Event name: NUEVO_GRUPO
  Action: new Group
  Data: GrupoDTO
- Event name: ACTUALIZA_GRUPO
  Action: update an existing Group and any update any existing link
  Data: GrupoDTO
- Event name: NUEVO_MIEMBRO_GRUPO
  Action: Add a new memebr to a group.
  Data: UsuarioDTO  (the group is inside the grupos relationship).
- Event name: NUEVO_USUARIO
  Action: Add a new user to an existing company (LegoSoft, LegoLock..).
  Data: UsuarioDTO.
- Event name: NUEVO_ADMINISTRADOR
  Action: Add a new administrator to an existing Group.
  Data: UsuarioDTO (the group is inside the grupos relationship).
- Event name: ACTUALIZACION_USUARIO
  Action: Updates any field from an existing user.
  Data: UsuarioDTO.
- Event name: ACTUALIZACION_ADMINISTRADOR
  Action: Updates any field from an existing administrator.
  Data: UsuarioDTO.
- Event name: ASIGNACION_FONDO
  Action: Assigns a Fondo/Afore to an Agent.
  Data: AssignFondoDTO. (name of the Fond/Afore and the Agent = UsuarioDTO)
- Event name: DES_ASIGNACION_FONDO
  Action: Un-assigns a Fondo/Afore to an Agent that has already been assigned
  Data: AssignFondoDTO. (name of the Fondo/Afore and the Agent = UsuarioDTO)
- Event name: APROBACION_ASIGNACION_FONDO
  Action: Authorization of an assignment for a Fondo/Afore to an Agent that has already been assigned
  Data: AproveAsingacionDTO. (name of the Fondo/Afore and the name of the Agent)
- Event name: ALTA_PERFIL
  Action: Insert a new Profile or any update
  Data: PerfilDTO.
- Event name: ACTUALIZA_PERFIL
  Action: Updates a Profile or any update
  Data: PerfilDTO.
- Event name: ASIGNACION_ROL
  Action: Assigns an existing role to a Profile
  Data: AssignRolDTO. (idRol and PerfilDTO)
- Event name: DES_ASIGNACION_ROL
  Action: Unassigns an existing role to an existing Profile
  Data: AssignRolDTO. (idRol and PerfilDTO)
- Event name: ALTA_ROL
  Action: Insert a new Role
  Data: RolDTO.
- Event name: ACTUALIZA_ROL
  Action: Updates a Role or any update
  Data: RolDTO
- Event name: ASIGNACION_FACULTAD
  Action: Assigns an existing permit to an exisitin Role
  Data: AssignFacultadDTO. (name of Permit  and RolDTO)
- Event name: DES_ASIGNACION_FACULTAD
  Action: Unassigns an existing permit to an exisitin Role
  Data: AssignFacultadDTO. (name of Permit  and RolDTO)
- Event name: ASIGNACION_PERFIL_USUARIO
  Action: Assign a profile to an existing user
  Data: AssignPerfilDTO. (name of Profile  and UsuarioDTO)
- Event name: ASIGNACION_FACULTAD_EXTRA_USUARIO
  Action: Assign an extra  permit to an exisiting User
  Data: AssignPerfilDTO. (name of Permit  and UsuarioDTO)
- Event name: DES_ASIGNACION_FACULTAD_EXTRA_USUARIO
  Action: Unassign an extra  permit to an exisiting User
  Data: AssignPerfilDTO. (name of Permit  and UsuarioDTO)
- Event name: PROHIBICION_DE_UNA_FACULTAD_AL_USUARIO
  Action: Forbid an assigned  permit to an exisiting User
  Data: AssignPerfilDTO. (name of Permit  and UsuarioDTO)
- Event name: BORRADO_DE_UNA_PROHIBICION_DE_UNA_FACULTAD_AL_USUARIO
  Action: Unforbid an assigned  permit to an exisiting User
  Data: AssignPerfilDTO. (name of Permit  and UsuarioDTO)


### TODO:Events listener

These are the event  that this microservice is a listener. Mainly are to keep in sync the `BUP` with
security.

- Event name: CreaParticipante
    - Producer: Participantes
    - Action: Insert a new Operadora/Afore, Group and its Administrator
    - Data: NewCorporativoDTO
    - note: No activation for Participante is done (i.e., activo = false).

- Event name: AutorizacionParticipante
    - Producer: Participantes
    - Action: Activate new Operadora/Afore, Group or a Fund (i.e., set the flag activo = true)

- Event name: CreaFondo
    - Producer: Particiantes
    - Action: Insert e new Fondo/Siefore  and link OPERADO_POR an existing Operadora/Afore
    - Data: NewFondoDTO
    - note: No activation is done.

- Event name: CreaSiefore
    - Producer: Particiantes
    - Action: Insert e new Fondo/Siefore  and link OPERADO_POR an existing Operadora/Afore
    - Data: NewFondoDTO
    - note: No activation is done.

- Event name: CreaFondoAseguradora
    - Producer: Particiantes
    - Action: Insert e new Fondo/Siefore  and link OPERADO_POR an existing Operadora/Afore
    - Data: NewFondoDTO
    - note: No activation is done.

- Event name: CreaFondoPrivado
    - Producer: Particiantes
    - Action: Insert e new Fondo/Siefore  and link OPERADO_POR an existing Operadora/Afore
    - Data: NewFondoDTO
    - note: No activation is done.
  
## Running on Docker Desktop

For docker-compose the `iamDB` is configured to be stored as a separate volume in order to protect data
in the /var/iamDB directory.

The directory following directory must exists inside the docker and have +rwx permission:

volumes:
- /var/neo4jDB/data:/data
- /var/neo4jDB/logs:/logs
- /var/neo4jDB/import:/var/lib/neo4j/import
- /var/neo4jDB/plugins:/plugins


### Create the image manually

```
./gradlew bootBuildImage
```

### Publish the image to GitHub manually

```
./gradlew bootBuildImage \
   --imageName ghcr.io/rlegorreta/iam-service \
   --publishImage \
   -PregistryUrl=ghcr.io \
   -PregistryUsername=rlegorreta \
   -PregistryToken=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
```

### Publish the image to GitHub from the IntelliJ

To publish the image to GitHub from the IDE IntelliJ a file inside the directory `.github/workflows/commit-stage.yml`
was created.

To validate the manifest file for kubernetes run the following command:

```
kubeval --strict -d k8s
```

This file compiles de project, test it (for this project is disabled for some bug), test vulnerabilities running
skype, commits the code, sends a report of vulnerabilities, creates the image and lastly push the container image.

<img height="340" src="./images/commit-stage.png" width="550"/>

For detail information see `.github/workflows/commit-stage.yml` file.


### Run the image inside the Docker desktop

```
docker run \
    --net ailegorretaNet \
    -p 8180:8180 \
    -e SPRING_PROFILES_ACTIVE=local \
    iam-service
```

Or a better method use the `docker-compose` tool. Go to the directory `ailegorreta-deployment/docker-platform` and run
the command:

```
docker-compose up
```

note: using docker-compose up to demostrate load balanced three `iam-service` are created with the
ports: 8180, 8181 & 8182 respectively.

## Run inside Kubernetes

### Manually

If we do not use the `Tilt`tool nd want to do it manually, first we need to create the image:

Fist step:

```
./gradlew bootBuildImage
```

Second step:

Then we have to load the image inside the minikube executing the command:

```
image load ailegorreta/iam-service --profile ailegorreta 
```

To verify that the image has been loaded we can execute the command that lists all minikube images:

```
kubectl get pods --all-namespaces -o jsonpath="{..image}" | tr -s '[[:space:]]' '\n' | sort | uniq -c\n
```

Third step:

Then execute the deployment defined in the file `k8s/deployment.yml` with the command:

```
kubectl apply -f k8s/deployment.yml
```

And after the deployment can be deleted executing:

```
kubectl apply -f k8s/deployment.yml
```

Fourth step:

For service discovery we need to create a service applying with the file: `k8s/service.yml` executing the command:

```
kubectl apply -f k8s/service.yml
```

And after the process we can delete the service executing:

```
kubectl deltete -f k8s/service.yml
```

Fifth step:

If we want to use the project outside kubernetes we have to forward the port as follows:

```
kubectl port-forward service/config-service 8071:80
```

Appendix:

If we want to see the logs for this `pod` we can execute the following command:

```
kubectl logs deployment/iam-service
```

### Using Tilt tool

To avoid all these boilerplate steps is much better and faster to use the `Tilt` tool as follows: first create see the
file located in the root directory of the proyect called `TiltFile`. This file has the content:

```
# Tilt file for config-service
# Build
custom_build(
    # Name of the container image
    ref = 'iam-service',
    # Command to build the container image
    command = './gradlew bootBuildImage --imageName $EXPECTED_REF',
    # Files to watch that trigger a new build
    deps = ['build.gradle', 'src']
)

# Deploy
k8s_yaml(['k8s/deployment.yml', 'k8s/service.yml'])

# Manage
k8s_resource('config-service', port_forwards=['8071'])
```

To execute all five steps manually we just need to execute the command:

```
tilt up
```

In order to see the log of the deployment process please visit the following URL:

```
http://localhost:10350
```

Or execute outside Tilt the command:

```
kubectl logs deployment/iam-service
```

In order to undeploy everything just execute the command:

```
tilt down
```

To run inside a docker desktop the microservice need to use http://iam-service:8180 to 8083 path


### Reference Documentation

* [Spring Boot Gateway](https://cloud.spring.io/spring-cloud-gateway/reference/html/)
* [Spring Boot Maven Plugin Reference Guide](https://docs.spring.io/spring-boot/docs/3.0.1/maven-plugin/reference/html/)
* [Config Client Quick Start](https://docs.spring.io/spring-cloud-config/docs/current/reference/html/#_client_side_usage)
* [Spring Boot Actuator](https://docs.spring.io/spring-boot/docs/3.0.1/reference/htmlsingle/#production-ready)

### Links to Springboot 3 Observability

https://tanzu.vmware.com/developer/guides/observability-reactive-spring-boot-3/

Baeldung:

https://www.baeldung.com/spring-boot-3-observability



### Contact AI Legorreta

Feel free to reach out to AI Legorreta on [web page](https://legosoft.com.mx).


Version: 2.0.0
©LegoSoft Soluciones, S.C., 2023
